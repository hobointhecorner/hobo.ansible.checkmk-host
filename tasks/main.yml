---
- name: Configure playbook
  ansible.builtin.include_tasks: tasks/playbook-facts.yml

- name: Ensure config directories
  become: true
  ansible.builtin.file:
    path: "{{ item }}"
    owner: "{{ checkmk_service_user }}"
    group: "{{ checkmk_service_group }}"
    mode: "2751"
    state: directory
  loop:
    - "{{ checkmk_service_config_dir }}"
    - "{{ checkmk_app_config_dir }}"

- name: Template docker compose file
  become: true
  ansible.builtin.copy:
    dest: "{{ checkmk_service_config_dir }}/docker-compose.yml"
    content: "{{ checkmk_host_compose_config | to_yaml(indent=2, sort_keys=false) }}"
    owner: "{{ checkmk_service_user }}"
    group: "{{ checkmk_service_group }}"
    mode: "640"
  notify: Reload checkmk service

- fail:

- name: Template systemd service file
  become: true
  ansible.builtin.template:
    src: checkmk-host.service.j2
    dest: "/etc/systemd/system/{{ checkmk_container_name }}.service"
    owner: root
    group: root
    mode: "640"
  notify: Reload checkmk service

- name: Flush handlers
  ansible.builtin.meta: flush_handlers

- name: Password change warning
  when: checkmk_password_set | bool
  ansible.builtin.fail:
    msg: Make sure to update your password from the management console then run this playbook again, omitting checkmk_password_set=true.
